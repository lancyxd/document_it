





### 1 混沌工程？

1. 在充分利用CPU的前提下，当一个后台应用的CPU使用率已经100%了，这个服务还可以从什么角度进行性能优化?
2. 基于线上正在运行的产品进行压力测试，会遇到什么具体问题，怎么解决？
3. 在混沌工程里面，如果步入深水区，需要面对的最困难的问题是什么？ 怎么解决？

参考链接：
[混沌工程(Chaos Engineering) 总结](https://zhuanlan.zhihu.com/p/90294032)
[混沌工程(Chaos Engineering) 到底是什么?](https://cloud.tencent.com/developer/article/1622874)

[华为云在混沌工程场景下的可靠性测试](https://www.infoq.cn/article/Pjd8yVzrCbYkDZj8K9dt)

[**为什么需要混沌工程？**](https://zhuanlan.zhihu.com/p/55973357)

[Chaos Engineering 的历史、原则以及实践](https://www.infoq.cn/article/chaos-engineering-the-history-principles-and-practice/?utm_campaign=infoq_content&utm_source=infoq&utm_medium=feed&utm_term=global)

```shell
# 在混沌工程里面，如果步入深水区，需要面对的最困难的问题是什么？ 怎么解决？最好能举例子?
个人认为该问题很宽泛，我把我对混沌工程的理解阐述如下:
1.混沌工程是针对分布式系统，有目的的搞破坏，以提升系统的可靠性。通过混沌试验可以增强应对故障的能力，可以识别出未知的问题，找出系统潜在的弱点。通过主动制造故障，测试系统在各种压力下的行为，识别并修复故障问题，避免造成严重后果。
2.实践步骤
1)定义并测量系统的稳定状态（例如：QPS、延迟等）;
2)创建假设:当我们做混沌实验时，这个系统的稳定状态应该没有变化;
3)模拟现实中可能发生的故障:模拟可能导致系统不可用或导致其性能降低的场景(例如：硬件故障，网络故障等)
4)证明猜想
将稳态指标与干扰注入系统后收集的指标进行比较。如果前后保持一致，则可以认为系统对该故障的有容错能力；两者状态若不一致，则找到了系统的弱点，去修复它。
3.混沌工程的难点?
在生产环境中进行混沌实验，尽可能的减少对用户的影响。可采用的手段为：服务级别、用户级别、流量路由，数据隔离等技术手段。

#  https://www.infoq.cn/article/bxGvrb_CxAZD6Wv3fUj8
2 混沌工程实践
1)混沌工程针对的是分布式系统。主要是检查各个程序之间的相通性。通过设计进行混沌实验，观察系统对各类故障的真实反映，以此来完善保证系统的稳定性。开展混沌工程的前提保障系统是容错的，即双活、多活系统。
判断一个程序的死活，很直观的就是写一个checker程序，定期运行以试探程序状态;
2) 实践层面的步骤
定义系统稳定状态(客户端指标定义系统，比如 QPS、延迟);
分为实验组和对照组进行试验，假设无论对实验组做任何操作，整个系统都可以继续维持稳定状态;
模拟现实世界可能发生的故障，比如硬件故障，网络延迟隔离等到实验组中；最后，比较实验组和对照组前后稳定状态的差异，是否可以满足预期。如果前后保持一致，则可以认为系统对该故障的有容错能力；两者状态若不一致，则找到了系统的弱点，去修复它。

一些指标定义系统稳态，比如 QPS；其次，假设客户端的 QPS 在受到攻击，Leader 节点被杀死后会出现一个抖动，Follower 会立马选出新的 Leader 节点，迅速恢复至稳定状态；第三步，进行错误注入实验；最后，观察结果，如果发现系统 QPS 降为零并再也没有恢复，证明系统有 bug，我们就需要去找出问题并修正；反之，如果 QPS 恢复了，则证明系统可以容忍这次故障，可以继续进行下一个实验。

3 混沌工程应用场景?
1) 手工注入（入门级可靠性测试）
功能: 提供对Kubernetes 集群、弹性云服务器的单业务实例、单故障模式的注入。
适用场景: 开发人员对确定故障的自验证；测试人员针对可靠性问题回归验证等。
操作流程: 安装探针——选择注入对象和注入故障——以5分钟为纬度获取监控数据生成测试报告——基于报告评估服务可靠性质量

2) 故障演练（进阶级可靠性测试）
功能: 提供对单个负载的随机故障注入，预置多种入门级和进阶级演练场景。
适用场景：线下随机故障注入测试；线上例行故障演练、专项演练等。
特点：模型化的场景定义、灵活的编排调度、丰富的评估报告。
操作流程: 设置演练场景——自动执行演练任务——自动生成演练报告

3) 自动测评（高级可靠性测试）
功能: 提供对多工作负载全量的可靠性测评。
适用场景: 云服务的全量可靠性测评;不同服务、不同版本的可靠性能力对比。
特点: 能对象识别、自动用例生成、无脚本化执行、自动 KPI 度量、丰富的评估报告。

# 概述总结
1混沌工程针对的是分布式系统，通过设计进行混沌实验，观察系统对各类故障的真实反映，以此来完善保证系统的稳定性。
2 实践步骤
1)定义并测量系统的稳定状态（例如：QPS、延迟等）;
2)创建假设:当我们做X时，这个系统的稳定状态应该没有变化;
3)模拟现实中可能发生的故障:模拟可能导致系统不可用或导致其性能降低的场景(例如：硬件故障，网络故障等)
4)证明猜想
将稳态指标与干扰注入系统后收集的指标进行比较。如果前后保持一致，则可以认为系统对该故障的有容错能力；两者状态若不一致，则找到了系统的弱点，去修复它。
3 paas层故障场景
1)负载均衡失效
2)数据库宕机、数据库连接满、数据库同步延迟、数据库主备延迟等
4 遵循原则
在开发混沌工程实验时，可遵循以下原则，将有助于实验设计：
建立稳定状态的假设；(稳定状态指标要统一)
多样化现实世界事件；(尽可能模拟真是要用户场景)
在生产环境运行实验；(生产环境中进行故障注入等试验)
持续自动化运行实验；
最小化“爆炸半径”(是否可以进一步减小故障的影响，比如微服务级别、请求级别甚至是用户级别;故障注入，流量路由和数据隔离技术也是减少业务影响的有效手段)
```

### 2  cpu满，应用程序如何优化？

```shell
# 在充分利用CPU的前提下，当一个后台应用的CPU使用率已经100%了，这个服务还可以从什么角度进行性能优化？
关注点: cpu、内存、磁盘、磁盘io、网络io
导致cpu使用率高的原因: 频繁读写、程序死循环等。
解决方案: 以数据入库mysql为例，插入数据采用分批插入方式；检测程序死循环的代码块，修正代码。
```

### 3  基于线上压测？

```shell
# 基于线上正在运行的产品进行压力测试，会遇到什么具体问题，怎么解决？最好能举例子
低业务量的时间段进行。
垃圾数据做标记。脚本清理垃圾数据。
ip识别转发(5台机器跑线上的服务，我进行线上压测的时候，要做ip转发，只测试其中的两台或者3台做压测。留一部分机器来支撑正常业务)
```

### 4  网络及系统可靠性

```shell
1) 网络指令
top  按数字1，各个cpu的详细利用率。
vmstat -n 3 2  # 每隔3秒取样1次，共取样2次 (主要关注procs和cpu，r：运行和等待cpu时间片的进程数，一般来说整个系统的运行队列不超过总核数的2倍; b:等待进程的资源数;us + sy 参考值为 80% ，如果大于 80% 的话，说明可能存在 CPU 不足)
free -m 内存   # 比较容易看，结果相对精准
df -h          # 排查磁盘空间够不够
iostat -xdk 3 2 #磁盘io (-x: 显示详细信息  -d: 显示磁盘使用情况 -k: 以 KB 为单位显示)rkB/s ：每秒读取数据量 kB ；wkB/s ：每秒写入数据量 kB ；svctm ：I/O 请求的平均服务时间，单位毫秒；util ：一秒中有百分之几的时间用于 I/O 操作，如果接近 100% 说明磁盘带宽跑满了，这个时候就要优化程序或者增加磁盘了。
sar -n DEV 3 2 # 网络io (-n 采样次数，默认为1次) rxpck/s ：每秒钟接收的数据包；txpck/s ：每秒钟发送的数据包；rxKB/s ：每秒接收的数据量，单位 KByte
；txKB/s ：每秒发出的数据量，单位 KByte

2) 服务不可用原因？
cpu满负荷，竞争激烈，处理不过来，造成假死。
内存溢出，物理内存不够，造成应用程序内存申请不到，直接退出。
io文件描述符创建过多，消耗系统资源，应用程序申请不到系统资源。
带宽过载，上下行带宽超过限制或者打满网卡。
程序bug引起的系统不可用或者内存泄露、死循环。
服务器宕机
3) 保证系统稳定可靠的方案?
垂直扩展: 垂直扩展提升系统的处理能力，如加cpu、内存等，但不能解决单点故障。
水平扩展: 通过冗余部署，解决单点故障，同时提升系统的处理能力，提高高可用性。
隔离: 对系统、业务的占用资源进行隔离，限制某个业务的资源占用数，避免一个业务占用整个系统资源，对其他业务造成影响。 常用的隔离有：进程隔离、线程隔离、模块隔离、应用隔离、机房隔离等，读写分离。
解耦: 降低系统之间的依赖关系，避免系统之间互相影响造成雪崩。将同步调用转换成异步消息交互，通过消息队列解耦系统之间的 依赖关系。
限流：一个系统的处理能力是有上限的，当服务请求量超过处理能力，通常会引起排队，造成响应时间迅速提升。如果对服务占用的资源量没有约束，可能导致资源占用过多而宕机。常用的限流方式有消费者端限流，提供者端限流，网关限流，限流算法有滑动窗口、漏桶算法，令牌桶算法等。
降级：是牺牲非核心的业务功能，保证核心功能的稳定运行。实现优雅的业务降级，需要将功能实现拆分到相对独立的不同代码单元，分优先级进行隔离，在后台通过开关控制。
熔断：在分布式系统中，如果调用的远程服务失败或者不可用，就会导致请求阻塞在服务器上等待从而造成耗尽服务器资源，引起雪崩效应。采用熔断机制，即使控制故障范围扩大，保证系统整体上可用，局部不可用。

4) 死锁？两个或两个以上的进程在执行过程中，由于资源竞争或者彼此通信而造成的一种阻塞现象。
进程和线程都可以发生死锁，只要满足死锁的条件？ 互斥条件; 请求与保持; 不可剥夺; 循环等待。
避免死锁? 对多个资源、数据库表、对象同时加锁时，需要保持一致的加锁顺序，否则可能会 造成死锁。说明：线程一需要对表 A、B、C 依次全部加锁后才可以进行更新操作，那么线程二的加锁顺序也必须是 A、B、C，否则可能出现死锁。
```



