## 1、go语言性能调优pprof

```shell
# 步骤简介：
1)启动http服务，用ab工具模拟向http服务（main函数中必须包含该包_ “net/http/pprof”）发送请求。
Ab –n 1000 –c 1000 –k http://127.0.0.1:9876/test
2)下载profile文件 http://127.0.0.1:9876/debug/pprof/profile
3) 执行go tool pprof ./pprofPractise profile，输入top，查看到cpu 占用前 10 的函数，我们可以对此分析进行优化。
输入web，会在浏览器中打开界面如下。
# 详细介绍：
go语言程序性能调优(服务器性能优化:CPU 和内存,在其不变的情况下，尽量地提高数据的处理能力和吞吐量)
go pprof性能调优(top命令显示cpu，web命令用图形化的方式来显示概要文件；概要文件:cpu概要文件，内存概要文件，程序阻塞概要文件。Linux go tool pprof;macos下go-torch)
_ “net/http/pprof”:只是使用runtime/pprof包进行封装了，并在http端口上暴露出来。Import _ 引用该包仅仅是希望它执行init()函数。
_ “runtime/pprof”  可以用来产生dump文件，再使用go tool pprof来分析这运行日志
 
启动，运行代码，然后模拟发请求。 https://github.com/caibirdme/hand-to-hand-optimize-go/blob/master/README.md

# 模拟请求
./wrk –c 400 –t 8 –d 3m http://127.0.0.1:9876/test   # 模拟http请求,使服务处于忙碌状态
ab –n 1000 –c 1000 –k http://127.0.0.1:9876/test
3.	文件下载(_ “net/http/pprof”)
http://127.0.0.1:9876/debug/pprof                   # 网页上，查看pprof，测试profo
http://127.0.0.1:9876/debug/pprof/profile --second N  # 网页上，下载profile文件(N秒的文件),其比较直观。
http://127.0.0.1:9876/debug/pprof/heap              # 网页上，用于内存快照文件
go tool pprof exd profile       # linux命令行下，exd为可执行文件，输入top可以检验cpu占前10的函数，对其进行优化;输入web,图形化的方式来显示概要文件。
 
# linux命令行下操作
go tool  pprof –text http://127.0.0.1:9876/debug/pprof/heap
go tool  pprof –text http://127.0.0.1:9876/debug/pprof/profile
 
# 参数解析
goroutine          活跃Goroutine的信息的记录。  仅在获取时取样一次。
Threadcreate   系统线程创建情况的记录。         仅在获取时取样一次。
Heap         堆内存分配情况的记录。     默认每分配512K字节时取样一次。
Block         Goroutine阻塞事件的记录。        默认每发生一次阻塞事件时取样一次。
 
# 可视化工具Graphviz安装。Pprof可以生成一个svg的矢量图，可以通过这svg图确认代码的流程及调用情况. Svg是使用graphviz生成的，mac下直接brew install graphviz就能安装，
centos下，sudo yum –y install graphviz
./configure
make
make install
```

## 2、服务器性能衡量指标（cpu，内存，网络）

```shell
https:#blog.csdn.net/qq_33623716/article/details/51504317
• 用vmstat、sar、iostat检测是否是CPU瓶颈 
• 用free、vmstat检测是否是内存瓶颈 
• 用iostat、dmesg检测是否是磁盘I/O瓶颈 
• 用netstat检测是否是网络带宽瓶颈

# 服务器性能衡量指标（cpu，内存，网络）
1. 吞吐率（Requests per second）
概念：服务器并发处理能力的量化描述，单位是reqs/s，指的是某个并发用户数下单位时间内处理的请求数。某个并发用户数下单位时间内能处理的最大请求数，称之为最大吞吐率。
公式：总请求数/处理完成这些请求数所花费的时间，即Request per second = Complete requests / Time taken for tests
吞吐率是基于并发用户的：吞吐率和并发用户数相关;不同的并发用户数下，吞吐率一般是不同的。
2. 并发连接数（The number of concurrent connections）
某个时刻服务器所接受的请求数目。
3. 并发用户数（The number of concurrent users，Concurrency Level）
要注意区分这个概念和并发连接数之间的区别，一个用户可能同时会产生多个会话，也即连接数。
4. 用户平均请求等待时间（Time per request）
处理完成所有请求数所花费的时间/（总请求数/并发用户数），即
Time per request = Time taken for tests /（ Complete requests / Concurrency Level）
5. 服务器平均请求等待时间（Time per request: across all concurrent requests）
计算公式：处理完成所有请求数所花费的时间/总请求数，即Time taken for / testsComplete requests
可以看到，它是吞吐率的倒数。

虚拟机和物理机区别：虚拟机是用软件的方式在你的物理机上模拟出一台新电脑，硬件等都是模拟出来的，所以性能会受物理机影响。物理机就是你的实体电脑。（linux命令区分：dmidecode –s system-product-name）

# 测试环境术语：
DEV Development 研发环境
SIT System Integrate Test 系统集成测试环境（内测）
UAT User Acceptance Test 用户验收测试环境
PET Performance Evaluation Test 性能评估测试环境（压测）
SIM Simulation 高仿真环境
PRD/PROD Production 正式/生产环境
```

## 3、http性能测试工具

### 3.1 **wrk**

```shell
wrk开源的性能测试工具,是一个很简单的 http 性能测试工具,也可以叫做 http benchmark 工具。通过命令行，可以做很多基于http性能的测试。通过异步网络 io 提升并发量. 所以网络通信不会阻塞线程执行. 这也是 wrk 可以用很少的线程模拟大量网路连接的原因
1. 安装
git clone https://github.com/wg/wrk.git 
cd wrk 
make 
备注:如果编译报错，安装sudo yum install  openssl-devel
 
2. 命令使用说明(编译后的wrk复制到指定目录中)
./wrk –t12 –c100 –d30s http://www.baidu.com     # 备注:用12个线程模拟100个连接
./wrk –t12 –c100 –d30s –T30s http://www.baidu.com
./wrk –t12 –c100 –d30s –T30s –latency http://www.baidu.com
 
-d  Duration of test设置测试的持续时间. 一般只要不是太短就可以
-t, --threads  Number of threads to use
-c, --connections  Connections to keep open
 
Latency: 可以理解为响应时间, 有平均值, 标准偏差, 最大值, 正负一个标准差占比.
Req/Sec: 每个线程每秒钟的完成的请求数, 同样有平均值, 标准偏差, 最大值, 正负一个标准差占比.
Wrk 默认超时时间是1秒. 这个有点短. 我一般设置为30秒. 这个看上去合理一点.(-T)
查看响应时间的分布情况,可以加上–latency参数
 
3. 有 POST,GET 等多个 method, 会有 Header, 会有 body，采用lua脚本操作。
./wrk –t12 –c100 –d30s –T30s –script=post.lua –latency http://www.baidu.com
 
POST + header + body
//post.lua的内容
wrk.method="POST"
wrk.body="foo=bar&baz=quux"
wrk.headers[“Content-Type”] = "application/x-www-form-urlencoded"
```

### 3.2 **ab(服务器的性能测试工具)**

```shell
ab（apache bench）是apache下的一个工具，主要用于对web站点做压力测试
1. 安装:
在任意目录下执行该命令：yum –y install httpd-tools
测试一下ab是否安装成功：ab –V
查看帮助：ab –help

2. 带body的http接口（post请求）
ab –n 1000 –c 10 –p ./tenant.json –T 'application/json' '127.0.0.1:20000/v1/search/tenant/info'

# tenant.json内容：{"userid":"mix"}

ab –n 1000 –c 10 –p ./tenant.json –T 'application/json' '127.0.0.1:31000/v1/search/tenant/info'
ab –n 10000 –c 1000 –p ./tenant.json –T 'application/json' –k '127.0.0.1:31000/v1/search/tenant/info' (加-k参数)
出错解决方案：https://mo2g.com/view/50/


ab –n300 –c10 "https://www.baidu.com/"
post文件里的参数写法如下： &param1=a&param2=b&param3=c
 
3. 常用参数：
-n在测试会话中所执行的请求总数。默认时，仅执行一个请求。
-c 一次产生的请求个数
-t 测试所进行的最大秒数。其内部隐含值是-n 50000，它可以使对服务器的测试限制在一个固定的总时间以内。
-p 包含了需要POST的数据的文件
-T POST数据所使用的Content-type头信息
-k 启用HTTP KeepAlive功能，即在一个HTTP会话中执行多个请求，默认时，不启用KeepAlive功能
-i执行HEAD请求，而不是GET
 
4. 大并发测试：
ulimit –n
ab –n 10000 –c 5000 –t 600 –k –p ./common_query_local.json –T 'application/json' 'http://127.0.0.1:12521/v1/search/index/query'
ab –n10000 –c1000 https://127.0.0.1:443**/**
ab –n 1000 –c 1000 –k http://127.0.0.1:9876/test
```

